function EventEmitter(){this.events={}}function Helper(){}function App(){this.url="/countries",this.countries=new Countries(document.querySelector("#countries")),this.cities=new Cities(document.querySelector("#cities")),this.resp=new Resp(document.querySelector("#response")),this.login=new Login(document.querySelector("#login-signup")),this.dataForServer={},this.init()}function Countries(t){t&&(this.el=t,this.elToAdd=this.el.querySelector("#countries-list"),this.elForAdd=this.el.querySelector("#country-input"),this.elBtn=this.el.querySelector("#country-btn"),this.events=new EventEmitter,this.init())}function Resp(t){t&&(this.el=t,this.elToResp=this.el.querySelector("#data-for-response"),this.addBtn=this.el.querySelector("#response-add-data"),this.updateBtn=this.el.querySelector("#response-update-data"),this.removeBtn=this.el.querySelector("#response-remove-data"),this.clearBtn=this.el.querySelector("#response-clear-data"),this.events=new EventEmitter,this.init())}function Login(t){t&&(this.el=t,this.loginBtn=this.el.querySelector("#login"),this.signupBtn=this.el.querySelector("#signup"),this.name=this.el.querySelector("#name"),this.password=this.el.querySelector("#password"),this.user=this.el.querySelector(".user"),this.events=new EventEmitter,this.init())}function Cities(t){t&&(this.el=t,this.elToAdd=this.el.querySelector("#cities-list"),this.elForAdd=this.el.querySelector("#city-input"),this.elBtn=this.el.querySelector("#city-btn"),this.events=new EventEmitter,this.init())}EventEmitter.prototype.on=function(t,e){"object"!=typeof this.events[t]&&(this.events[t]=[]),this.events[t].push(e)},EventEmitter.prototype.emit=function(t){if("object"==typeof this.events[t])for(var e=[].slice.call(arguments,1),i=this.events[t].slice(),s=i.length,n=0;n<s;n++)i[n].apply(this,e)},EventEmitter.prototype.removeListener=function(t,e){if("object"==typeof this.events[t]){var i=this.events[t].indexOf(e);i!==-1&&this.events[t].splice(i,1)}},Helper.prototype.XMLLoad=function(t,e,i,s,n){"use strict";var o=new XMLHttpRequest;o.addEventListener("readystatechange",function(){4==o.readyState&&200==o.status&&i(o.responseText)}),o.open(t,e,!0),o.setRequestHeader("Content-type",n||"application/x-www-form-urlencoded"),o.setRequestHeader("Authorization",sessionStorage.getItem("token")),o.send(s||null)},App.prototype=Object.create(Helper.prototype),App.prototype.init=function(){this.countries.on("choose-countries",this.chooseCountries.bind(this)),this.countries.on("country-create",this.countryCreate.bind(this)),this.cities.on("city-enter",this.citiesEnter.bind(this)),this.cities.on("city-create",this.citiesCreate.bind(this)),this.resp.on("resp-clear",this.respClear.bind(this)),this.resp.on("resp-add",this.respAdd.bind(this)),this.resp.on("resp-update",this.respUpdate.bind(this)),this.resp.on("resp-del",this.respDel.bind(this)),this.login.on("login",this.loginSend.bind(this)),this.login.on("signup",this.signupSend.bind(this)),this.XMLLoad("GET",this.url,this.addDatafromDatabase.bind(this)),sessionStorage.setItem("token","")},App.prototype.addDatafromDatabase=function(t){for(var t=JSON.parse(t),e=0;e<t.length;e++)this.dataAddDo(t[e])},App.prototype.dataAddDo=function(t){this.countries.addCountry(t.id);var e=t.cities;if(e)for(var i=0;i<e.length;i++)this.cities.addCity(e[i],t.id)},App.prototype.chooseCountries=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i].innerHTML);this.cities.chooseInList(e)},App.prototype.countryCreate=function(t){if("string"==typeof t&&""!==t){var t=t[0].toUpperCase()+t.slice(1);this.dataForServer.id=t,this.sendToResp(),this.cities.startChooseCities(this.dataForServer.id)}},App.prototype.citiesCreate=function(t){if("string"==typeof t&&""!==t){var t=t[0].toUpperCase()+t.slice(1);if(void 0===this.dataForServer.id)return void this.countries.elForAdd.focus();this.dataForServer.cities=t,this.sendToResp()}},App.prototype.sendToResp=function(){var t="";for(var e in this.dataForServer){var i="id"===e?"country":e;t+=i+": "+this.dataForServer[e]+"; "}this.resp.showData(t),this.resp.checkBtns(""!==t)},App.prototype.citiesEnter=function(t){this.countryCreate(t.getAttribute("country-name")),this.citiesCreate(t.innerHTML)},App.prototype.respClear=function(){this.countries.elForAdd.value="",this.countries.findInList(""),this.cities.elForAdd.value="",this.cities.setAllShow(),this.cities.findInList(""),this.dataForServer={},this.sendToResp()},App.prototype.respAdd=function(){this.XMLLoad("POST",this.url,this.apdateAllLists.bind(this),JSON.stringify(this.dataForServer),"application/json")},App.prototype.respUpdate=function(){this.XMLLoad("PUT",this.url,this.apdateAllLists.bind(this),JSON.stringify(this.dataForServer),"application/json")},App.prototype.respDel=function(){this.XMLLoad("DELETE",this.url,this.apdateAllLists.bind(this),JSON.stringify(this.dataForServer),"application/json")},App.prototype.apdateAllLists=function(t){this.resp.showData(""),this.dataForServer={},this.countries.elForAdd.value="",this.countries.findInList(""),this.cities.elForAdd.value="",this.cities.findInList("");var t=JSON.parse(t);if(t.success===!1)this.login.hideUser();else{this.countries.clearAllList(),this.cities.clearAllList();for(var e=0;e<t.length;e++)this.dataAddDo(t[e])}},App.prototype.loginSend=function(t){this.XMLLoad("POST","/login",this.getToken.bind(this),JSON.stringify(t),"application/json")},App.prototype.signupSend=function(t){this.XMLLoad("POST","/signup",this.getToken.bind(this),JSON.stringify(t),"application/json")},App.prototype.getToken=function(t){var t=JSON.parse(t);console.log(t),t.success?(this.login.showUser(t.user.name),sessionStorage.setItem("token",t.token)):sessionStorage.setItem("token","")},window.addEventListener("DOMContentLoaded",function(){new App}),Countries.prototype={init:function(){this.el.addEventListener("click",this.delegationClick.bind(this)),this.el.addEventListener("keyup",this.delegationKeyup.bind(this))},delegationClick:function(t){var e=t.target;"LI"===e.tagName&&(this.enterCountry(e),this.emit("country-create",e.innerHTML)),e===this.elBtn&&this.createCountry()},delegationKeyup:function(t){t.target;if(this.findInList(this.elForAdd.value),13===t.keyCode){var e=this.elToAdd.querySelector(".show-list");this.enterCountry(e)}},addCountry:function(t){"string"==typeof t&&""!==t&&this.elToAdd.insertAdjacentHTML("beforeend","<li>"+t+"</li>")},clearAllList:function(){for(;this.elToAdd.firstChild;)this.elToAdd.removeChild(this.elToAdd.firstChild)},hideAll:function(){for(var t=this.elToAdd.children,e=0;e<t.length;e++)t[e].classList.remove("show-list","selected"),t[e].classList.add("hide")},unSelected:function(){for(var t=this.elToAdd.children,e=0;e<t.length;e++)t[e].classList.remove("selected")},findInList:function(t){this.elForAdd.value?this.elBtn.removeAttribute("disabled"):this.elBtn.setAttribute("disabled","disabled");var e=this.elToAdd.children;this.hideAll();for(var i=0;i<e.length;i++)e[i].innerHTML.toLowerCase().indexOf(t.toLowerCase())!==-1&&(e[i].classList.remove("hide"),e[i].classList.add("show-list"));var s=this.elToAdd.querySelectorAll(".show-list");this.emit("choose-countries",s)},chooseInList:function(t){function e(t){return function(e,i,s){for(var i=0;i<t.length;i++)e===t[i].innerHTML&&(t[i].classList.remove("hide"),t[i].classList.add("show-list"))}}this.hideAll();var i=this.elToAdd.children;t.forEach(e(i))},enterCountry:function(t){return t?(this.unSelected(),t.classList.add("selected"),void this.emit("country-create",t.innerHTML)):void this.createCountry()},getByHtml:function(t){for(var e=this.elToAdd.children,i=0;i<e.length;i++)if(e[i].innerHTML.toLowerCase()===t.toLowerCase())return e[i]},createCountry:function(){""!==this.elForAdd.value&&this.emit("country-create",this.elForAdd.value)},emit:function(t,e){this.events.emit(t,e)},on:function(t,e){this.events.on(t,e)}},Resp.prototype={init:function(){this.el.addEventListener("click",this.delegationClick.bind(this))},delegationClick:function(t){var e=t.target;e===this.addBtn&&this.emit("resp-add"),e===this.removeBtn&&this.emit("resp-del"),e===this.clearBtn&&this.emit("resp-clear"),e===this.updateBtn&&this.emit("resp-update")},showData:function(t){""===t&&(t="country: ; city: ;"),this.elToResp.innerHTML=t},checkBtns:function(t){var e={add:function(){this.addBtn.setAttribute("disabled","disabled"),this.removeBtn.setAttribute("disabled","disabled"),this.updateBtn.setAttribute("disabled","disabled")},remove:function(){this.addBtn.removeAttribute("disabled"),this.removeBtn.removeAttribute("disabled"),this.updateBtn.removeAttribute("disabled")}};t?e.remove.call(this):e.add.call(this)},emit:function(t,e){this.events.emit(t,e)},on:function(t,e){this.events.on(t,e)}},Login.prototype={init:function(){this.el.addEventListener("click",this.delegationClick.bind(this))},delegationClick:function(t){var e=t.target;e===this.loginBtn&&this.login(),e===this.signupBtn&&this.signup()},clearInputs:function(){this.name.value="",this.password.value=""},login:function(){""!==this.name.value&&""!==this.password.value&&this.emit("login",{name:this.name.value,password:this.password.value})},signup:function(){""!==this.name.value&&""!==this.password.value&&this.emit("signup",{name:this.name.value,password:this.password.value})},showUser:function(t){this.user.innerHTML="Hi, "+t,this.user.classList.remove("hide"),this.el.querySelector(".form-group").classList.add("hide")},hideUser:function(){this.user.classList.add("hide"),this.el.querySelector(".form-group").classList.remove("hide")},emit:function(t,e){this.events.emit(t,e)},on:function(t,e){this.events.on(t,e)}},Cities.prototype={init:function(){this.el.addEventListener("click",this.delegationClick.bind(this)),this.el.addEventListener("keyup",this.delegationKeyup.bind(this))},delegationClick:function(t){var e=t.target;"LI"===e.tagName&&this.enterCity(e),e===this.elBtn&&this.createCity()},delegationKeyup:function(t){t.target;if(this.findInList(this.elForAdd.value),13===t.keyCode){var e=this.elToAdd.querySelector(".show-list");this.enterCity(e)}},addCity:function(t,e){("string"==typeof t&&""!==t||"string"==typeof e&&""!==e)&&this.elToAdd.insertAdjacentHTML("beforeend",'<li show country-name="'+e+'">'+t+"</li>")},clearAllList:function(){for(;this.elToAdd.firstChild;)this.elToAdd.removeChild(this.elToAdd.firstChild)},hideAll:function(){for(var t=this.elToAdd.children,e=0;e<t.length;e++)t[e].classList.add("hide"),t[e].classList.remove("show-list","selected")},findInList:function(t){this.elForAdd.value?this.elBtn.removeAttribute("disabled"):this.elBtn.setAttribute("disabled","disabled");var e=this.getByAttribute("show");this.hideAll();for(var i=0;i<e.length;i++)e[i].innerHTML.toLowerCase().indexOf(t.toLowerCase())!==-1&&(e[i].classList.remove("hide"),e[i].classList.add("show-list"))},setAllShow:function(){for(var t=this.elToAdd.children,e=0;e<t.length;e++)t[e].setAttribute("show","")},chooseInList:function(t){function e(t){return function(e,i,s){for(var i=0;i<t.length;i++)e===t[i].getAttribute("country-name")?(t[i].classList.remove("hide"),t[i].classList.add("show-list"),t[i].setAttribute("show","")):t[i].removeAttribute("show")}}this.elBtn.setAttribute("disabled","disabled"),this.hideAll();var i=this.elToAdd.children;t.forEach(e(i)),this.elForAdd.setAttribute("disabled","disabled")},getByAttribute:function(t){for(var e=[],i=this.elToAdd.children,s=0;s<i.length;s++)i[s].hasAttribute(t)&&e.push(i[s]);return e},enterCity:function(t){return t?(this.unSelected(),this.emit("city-enter",t),void t.classList.add("selected")):void this.createCity()},unSelected:function(){for(var t=this.elToAdd.children,e=0;e<t.length;e++)t[e].classList.remove("selected")},startChooseCities:function(t){this.chooseInList([t]),this.elForAdd.removeAttribute("disabled"),this.elForAdd.focus()},createCity:function(){""!==this.elForAdd.value&&this.emit("city-create",this.elForAdd.value)},emit:function(t,e){this.events.emit(t,e)},on:function(t,e){this.events.on(t,e)}};